\documentclass[11pt]{article}

\pdfobjcompresslevel=3    % compress PDF objects
\pdfcompresslevel=9       % compress streams more (0..9)
\pdfminorversion=4


\usepackage[utf8]{inputenc} % remove if using XeLaTeX or LuaLaTeX
\usepackage[T1]{fontenc}
\usepackage{polski}[babel]

% Layout & graphics
\usepackage[a4paper, total={7.5in, 9in}]{geometry}
\usepackage{graphicx}
\usepackage{wrapfig}              % images
\usepackage[dvipsnames,table]{xcolor} % single xcolor invocation (keeps table option)

% Math & symbols
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{gensymb}

% Typography & layout helpers
\usepackage{microtype}
\usepackage{float}                 % [H] placement
\usepackage{caption}
\usepackage{subcaption}            % modern subfigure support (do NOT load subfig)
\usepackage{multirow}
\usepackage{titlesec}

\usepackage{lmodern}
\usepackage{microtype}
\usepackage{listings}
\usepackage{xcolor}

\lstdefinestyle{MyStyle}{
    basicstyle=\ttfamily\small, % Font family and size
    keywordstyle=\color{blue}\bfseries, % Style for keywords
    commentstyle=\color{green!60!black}\itshape, % Style for comments
    %stringstyle=\color{red}, % Style for strings
    numberstyle=\tiny\color{gray}, % Style for line numbers
    backgroundcolor=\color{gray!10}, % Background color
    frame=single, % Add a frame around the code block
    breaklines=true, % Allows long lines to wrap
    language=Java, % Default language
    numbers=left, % Line numbers on the left
    showstringspaces=false % Don't show spaces in strings
}

\lstset{style=MyStyle}

\definecolor{xppblue}{RGB}{37, 150, 190}

\title{Sprawozdanie 1 z laboratorium \par Układy sterowania optymalnego}
\author{Jan Andrzejewski 159512}
\date{}

\begin{document}

\maketitle

\tableofcontents

\newpage

\section{Ćwiczenie 3-4}
\subsection{Układ RC}

Pod rozwagę brany jest układ RC przedstawiony na Rysunku 1.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{img/ukladrc.png}
    \caption{Układ RC}
\end{figure}

Gdzie:
\[
R_1=1\Omega \qquad C_1=1F
\]
\[
 R_2=1\Omega \qquad C_2=2F
\]
\[
R_3=1\Omega \qquad C_3=3F
\]

Przyjęto, że: $x1 = u_{c1}$, $x2 = u_{c2}$, $x3 = u_{c3}$.

Równania stanu:
\[
\dot{x}=
\begin{bmatrix}
 -\dfrac{1}{R_1 C_1} & 0 & 0 \\
 0 & -\dfrac{1}{R_2 C_2} & 0 \\
 0 & 0 & -\dfrac{1}{R_3 C_3}
\end{bmatrix}x + 
\begin{bmatrix}
    -\dfrac{1}{R_1 C_1} \\
    -\dfrac{1}{R_2 C_2}\\
    -\dfrac{1}{R_3 C_3} \\
\end{bmatrix}u
\]

\subsection{Teoretyczne badanie sterowalności}
\[
K=\begin{bmatrix}
    A & AB & A^2 B\\
\end{bmatrix}=\begin{bmatrix}
    1 & -1 & 1 \\
 0.5 & -0.25 & 0.125 \\
 0.(3) & -0.(1) & 0.(037)
\end{bmatrix}
\]

\[
rank(K)=3 
\]
\[
n=3
\]

Rząd macierzy Kalmana jest równy 3, zgadza się z rozmiarem macierzy A, co świadczy o tym, że system jest sterowalny.

\subsection{Postać sterowalna}

Aby doprowadzić system do postaci sterowalnej, skorzystamy z zależności:
\[
\phi(s)=det(Is-A)=s^n+\sum_{i=0}^{n-1}a_is^i
\]

W przypadku układu RC:
\[
\phi(s)=det \bigg(\begin{bmatrix}
    s & 0 & 0 \\
 0 & s & 0 \\
 0 & 0 & s
\end{bmatrix}-\begin{bmatrix}
    -1 & 0 & 0 \\
 0 & -\frac{1}{2} & 0 \\
 0 & 0 & -\frac{1}{3}
\end{bmatrix} \bigg)=(s+1)(s+\frac{1}{2})(s+\frac{1}{3})=s^2+\frac{11}{6}s^2+s+\frac{1}{6}
\]

Postać sterowalna układu RC wygląda następująco:

\[
\dot{x}=\begin{bmatrix}
    0 & 1 & 0 \\
 0 & 0 & 1 \\
 -\frac{1}{6} & -1 & -\frac{11}{6}
\end{bmatrix}x+\begin{bmatrix}
    0\\
    0\\
    1
\end{bmatrix}u
\]


\subsection{Porównanie obiektu opisanego postacią normalną regulatorową i sterowalną}


Dla danego układu RC zaimplementowano postać sterowalną i zbadano zgodność wyjść z oryginalną postacią 

\begin{figure}[H]
\centering
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=1\linewidth]{img/wyjsciajednostkowy.png}
  \caption{Oryginalna}
  \label{fig:sub1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=1\linewidth]{img/wyjsciajednostkowysterowalna.png}
  \caption{Sterowalna}
  \label{fig:sub2}
\end{subfigure}
\caption{Wykresy przebiegów wyjść dla pobudzenia skokiem jednostkowym}
\label{fig:test}
\end{figure}

Zgodnie z założeniami zmiana reprezentacji nie zmieniła przebiegu wyjść. Dowodzi to, że każdy system liniowy można zapisać w nieskończonej ilości kombinacji zapisu macierzowego równań stanu.

Pomimo że zmiana zapisu nie wpłynęła na przebiegi wyjść, zmieniły się przebiegi zmiennych stanu. Wniosek: zmiana macierzy opisujących system nie ma wpływu na charakter wyjścia, zmienia natomiast sposób, w jaki osiągamy wyjście, czyli kombinacje zmiennych stanu składających się na wyjście 

\begin{figure}[H]
\centering
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=1\linewidth]{img/zmiennestanuog.png}
  \caption{Oryginalne zmienne stanu}
  \label{fig:sub1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=1\linewidth]{img/zmiennestanuster.png}
  \caption{Zmienne stanu reprezentacji sterowalnej}
  \label{fig:sub2}
\end{subfigure}
\caption{Wykresy przebiegów zmiennych stanu dla pobudzenia skokiem o amplitudzie 2}
\label{fig:test}
\end{figure}

\begin{figure}[H]
\centering
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=1\linewidth]{img/zmiennestanuogsin.png}
  \caption{Oryginalne zmienne stanu}
  \label{fig:sub1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=1\linewidth]{img/zmiennestanustersin.png}
  \caption{Zmienne stanu reprezentacji sterowalnej}
  \label{fig:sub2}
\end{subfigure}
\caption{Wykresy przebiegów zmiennych stanu dla pobudzenia sinusem}
\label{fig:test}
\end{figure}


Przeprowadzone symulacje jasno dowodzą relacji pomiędzy postacią 
normalną regulatorową a postacią sterowalną. Zmiana reprezentacji układu nie 
zmienia jego obserwowalnego zachowania. Zmienia jedynie wewnętrzny przebieg zmiennych stanu, 
które z fizykalnych wielkości zmieniają się w ich liniowe kombinacje.  


\subsection{Lokowanie biegunów}

Za cel obrano ulokowanie biegunów w lewej półpłaszczyźnie, co oznacza, że układ ma być stabilny. Należy spodziewać się, że układ pozbawiony wejścia i wytrącony z równowagi powróci do stanu równowagi 

\[
s_1=-1 \qquad s_2=-2 \qquad s_3=-5
\]

Macierz wzmocnień wyznaczono przy użyciu funkcji place\_poles:
\begin{lstlisting}
  desired=[-1,-2,-5]

  res = scipy.signal.place_poles(An,Bn,desired)
  K=res.gain_matrix
\end{lstlisting}

\[
K = \begin{bmatrix} 9.83333333 & 16 & 6.16666667 \\ \end{bmatrix}
\]

Następnie sformułowano prawo sterowania układu zamkniętego:
\[
\dot{x}=A_{closed}x+B_{closed}u
\]
Gdzie:
\[
A_{closed}=A_n-B_n K
\]
\[
B_{closed}=\begin{bmatrix}
  0\\
  0\\
  0
\end{bmatrix}
\]
Ponieważ badana jest stabilność układu zamkniętego, zmieniane będą
warunki początkowe bez podawania sygnału sterującego. Z tego powodu $B_{closed}$ może być kolumną zer.
Układ wytrącono z równowagi w postaci warunków początkowych wynoszących $\dot{x} = \begin{bmatrix} 1 & 0.5 & -0.5 \\ \end{bmatrix}$
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{img/zamkniety.png}
    \caption{Przebieg zmiennych stanu układu zamkniętego}
\end{figure}


\section{Ćwiczenie 5}

Na zajęciach numer 5 przedstawiono metody optymalizacji matematycznej, rozpatrywano dany problem:
\[
J=\int_{0}^{1}24x(t)t+2\dot{x}(t)^2-4tdt \rightarrow min
\]
z ograniczeniami 
\[
x(0)=1 \qquad x(1)=3
\]
Pomijając przekształcenia, ostatecznie otrzymano analitycznie optymalną trajektorię:
\[
x^*=t^3+t+1
\]

\newpage

\subsection{Kod wykorzystany do przeprowadzenia optymalizacji dynamicznej}

\begin{lstlisting}
m2=GEKKO()

m2.options.IMODE=6

n_points = 201
m2.time = np.linspace(0, 1, n_points)

x= m2.Var(value=1)

m2.fix_initial(x, val=1) # x(0)=1
m2.fix_final(x, val=3) # x(1)=3

J = m2.Var(value=0)
m2.fix_initial(J, val=0)

t = m2.Param(value=m2.time)

integrand = 24*x*t + 2*x.dt()**2 - 4*t #x.dt to x prim

m2.Equation(J.dt() == integrand)

J_f = m2.FV()
J_f.STATUS = 1 

m2.Connection(J_f, J, pos2='end')

m2.Obj(J_f)

m2.options.SOLVER=3

m2.solve(disp=False)

x_res=np.array(x.value)
J_res=J_f.value[0]

print(f'minimalna wartosc calki= {J_res:.6f}')
\end{lstlisting}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\linewidth]{img/trajektorielab5.png}
\end{figure}

Po wyznaczeniu wektora wartości dla trajektorii wyznaczonej analitycznie i naniesieniu jej na jeden wykres wspólnie z trajektorią obliczoną przez GEKKO, można stwierdzić, że trajektorie te pokrywają się z nieznacznym błędem. Do wyznaczenia rzędu tego błędu może posłużyć wartość całkowego wskaźnika jakości:
\[
J_{GEKKO}= 32.729852
\] 
\[
J_{analitycznie}=\int_{0}^{1} 24x(t)t+2\dot{x}(t)^2-4t dt
\]
\begin{center}
jeśli:
\[
x(t)=t^3+t+1
\]
\[
\dot{x}(t)=3t^2+1
\]
to:
\end{center}
\[
J_{analitycznie}=\int_{0}^{1} 24(t^3+t+1)t + 2(3t^2+1)^2 -4t dt = \frac{162}{5} = 32,4
\]

Co daje błąd na poziomie:
\[
\frac{32,729852-32,4}{32,4}\cdot 100\%=1,01\%
\]

Biorąc pod uwagę błąd rzędu 1\%, można uznać metody optymalizacji dynamicznej przy użyciu 
GEKKO za bardzo wiarygodne.
\section{Ćwiczenie 6} 
\subsection{Rozważany układ}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/ukladdopid.png}
  \caption{Rozważany układ elektryczny}
\end{figure}

Dla danego układu z parametrami $R_1=2\Omega$, $R_2=5\Omega$, $C_1=0.5F$, $L_1=2H$ i $L_2=0.5H$, przyjmując zmienne w postaci $x=\begin{bmatrix}
  i_1 & i_2 & u_2 
\end{bmatrix}^T$, wyznaczono równania stanu:
\[
\dot{x}=\begin{bmatrix}
  -\frac{R_1}{L_1} & 0 & -\frac{1}{L_1}\\
  0 & -\frac{R_2}{L_2} & \frac{1}{L_1}\\
  \frac{1}{C_1}& -\frac{1}{C_1}&0
\end{bmatrix}x +\begin{bmatrix}
  \frac{1}{L_1} \\ 0\\0
\end{bmatrix}u
\]

\subsection{Przebieg wyjścia układu z regulatorem PID}

Dla danego układu zaimplementowano regulator PID. 
\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/pid1.png}
  \caption{Przebieg wyjścia dla empirycznie dobranych nastawów}
\end{figure}

Taki przebieg uzyskano dla empirycznie dobranych nastawów:
\[
\begin{bmatrix}
  k_P\\
  k_I\\
  k_D
\end{bmatrix}=\begin{bmatrix}
  10\\
  5\\
  5
\end{bmatrix}
\]

\subsection{Rola poszczególnych wzmocnień w regulatorze PID}

Regulator PID składa się z trzech członów: proporcjonalnego ($P$), całkującego ($I$) oraz różniczkującego ($D$). Każdy z nich pełni określoną rolę w procesie regulacji:
\begin{itemize}
    \item \textbf{Człon proporcjonalny ($K_P$):} Odpowiada za szybkość reakcji na uchyb regulacji. Zwiększenie wzmocnienia $K_P$ powoduje szybszą reakcję układu i zmniejszenie uchybu ustalonego, ale zbyt duża wartość może prowadzić do przeregulowań i oscylacji.
    \item \textbf{Człon całkujący ($K_I$):} Jego zadaniem jest eliminacja uchybu w stanie ustalonym. Działa poprzez sumowanie uchybu w czasie. Zbyt duże wzmocnienie $K_I$ może powodować przeregulowania i wydłużyć czas ustalania się odpowiedzi.
    \item \textbf{Człon różniczkujący ($K_D$):} Reaguje na szybkość zmian uchybu, co pozwala przewidywać jego przyszłe wartości. Działa tłumiąco na oscylacje i poprawia stabilność układu.
\end{itemize} 

\subsection{Metoda Zieglera-Nicholsa}

Metoda Zieglera-Nicholsa polega na odnalezieniu
krytycznej wartości wzmocnienia $k_p$, dla której układ znajduje się na granicy stabilności. Wprowadzając układ na granicę stabilności, zaczną występować oscylacje. Dla poprawnego wyznaczenia wzmocnień według metody Z-N należy wyznaczyć okres tych oscylacji.

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/granica.png}
  \caption{Przebieg wyjścia układu na granicy stabilności}
\end{figure}

Z wyznaczonymi parametrami $k_u$ i $T_u$ można wyznaczyć wzmocnienia dla poszczególnych członów różnych regulatorów.

\begin{table}[H]
  \centering
\begin{tabular}{|l|l|l|l|}
\hline
Regulator & kp     & ki     & kd      \\ \hline
P         & 37,75  & -      & -       \\ \hline
PI        & 33,975 & 25,16  & -       \\ \hline
PD        & 60,4   & -      & 12,231  \\ \hline
PID       & 45,3   & 55,926 & 9,17325 \\ \hline
\end{tabular}
\caption{Parametry PID}
\end{table}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/pidsymulacjezg.png}
  \caption{Przebiegi wyjścia dla różnych regulatorów}
\end{figure}

\subsection{Całkowe wskaźniki jakości}
\begin{table}[H]
  \centering
\begin{tabular}{|l|l|l|l|l|}
\hline
Nastawy         & ISE   & ITSE & IAE   & ITAE  \\ \hline
Ziegler-Nichols & 12.2  & 29.9 & 10.3  & 57.12 \\ \hline
szybki          & 4.57  & 1.56 & 2.45  & 1.97  \\ \hline
wolny           & 13.71 & 27.9 & 10.08 & 46.9  \\ \hline
\end{tabular}
\caption{Wartości całkowych wskaźników jakości dla q=r=1}
\end{table}

\begin{figure}[H]
\centering
  \includegraphics[width=0.5\linewidth]{img/wskaznikipid.png}
  \caption{Przebiegi dla różnych nastawów i $q=r=1$}
\end{figure}

Wskaźnik ISE wyznacza się jako $\int_{0}^{T}e^2(t)dt$. Duże wartości uchybu przekładają się na bardzo duży wzrost wartości wskaźnika jakości. Na wykresie wyraźnie widać, że najmniejszą wartość ISE udało się osiągnąć dla przebiegu wyjścia z najmniejszymi przeregulowaniami. 

W przypadku, kiedy rozważany jest wskaźnik $I_{opt}$, zmiana współczynników $q$ i $r$ zmienia proporcje, w jakich brany jest pod uwagę uchyb i sygnał sterujący. Modyfikując $q$ i $r$, wpływa się na priorytet sterowania: $q$ wpływa na uchyb, czyli precyzję sterowania, a $r$ wpływa na sygnał sterujący, czyli energię dostarczoną do układu. Zmieniając $q$ i $r$, naturalnie zmieniają się nastawy regulatora, ponieważ zostaną zmienione narzucone odgórnie kryteria, według których ma się odbywać sterowanie.

\subsection{Model ze wskaźnikami całkowymi}

\begin{lstlisting}
  def model_with_pid_integralquality(x,t, yd, Kp, Ki, Kd, q, r):
    R1, R2 = 2, 5
    L1, L2 = 2, 0.5
    C1 = 0.5

    x_sys = x[:3]

    integral_e = x[3]
    integral_e2 = x[4]
    integral_te2 = x[5]
    integral_abs_e = x[6]
    integral_t_abs_e = x[7]
    integral_qe2_ru2 = x[8]
    

    A = np.array([[-R1/L1, 0, -1/L1], [0, -R2/L2, 1/L1], [1/C1, -1/C1, 0]])
    B = np.array([[1/L1], [0], [0]])
    C = np.array([[0, 1, 0]])
    D = 0

    y = C @ x_sys

    dxdt = A @ x_sys

    dydt = C @ dxdt

    e = yd - y
    dedt = -dydt

    u = Kp*e + Ki*integral_e + Kd*dedt

    dxdt_sys = A @ x_sys + (B * u).flatten()

    dintegral_e = e[0]
    dintegral_e2 = e[0]**2
    dintegral_te2 = t*e[0]**2
    dintegral_abs_e = abs(e[0])
    dintegral_t_abs_e = t*abs(e[0])
    dintegral_qe2_ru2 = q*e[0]**2 + r*u[0]**2

    return np.concatenate((dxdt_sys, [dintegral_e],[dintegral_e2],[dintegral_te2],[dintegral_abs_e],[dintegral_t_abs_e],[dintegral_qe2_ru2]))
\end{lstlisting}


\section{Ćwiczenie 7-8}

\subsection{Rozważany układ}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/lqruklad.png}
  \caption{Rozważany układ RLC}
\end{figure}

Z przyjętymi parametrami $R=0.5\Omega$, $L=0.2H$ i $C=0.5F$, gdzie za zmienne stanu przyjęto $x=\begin{bmatrix}
  q_c & \dot{q_c}
\end{bmatrix}^T$, wyprowadzono równania stanu:

\[
\dot{x}=\begin{bmatrix}
  0 & 1\\
  -\frac{1}{LC} & -\frac{R}{L}
\end{bmatrix}x + \begin{bmatrix}
  0 \\
  \frac{1}{L}
\end{bmatrix}u
\]

\subsection{Macierz $K$ dla nieskończonego horyzontu czasowego}

Macierz wzmocnień wyznaczona poprzez rozwiązanie algebraicznego równania Riccatiego dla rozważanego układu i parametrów $Q=I_2$ i $R=1$.

\[
K=\begin{bmatrix}
  0.23606798 & 0.65949437
\end{bmatrix}
\]

\subsection{Odpowiedź skokowa układu RLC dla jednostkowych R i Q}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/skoklqr1.png}
  \caption{Odpowiedź układu na wymuszenie w postaci wytrącenia z równowagi}
\end{figure}

\subsection{Wpływ parametrów $Q$ i $R$ na sterowanie}
\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/zmiennestanulqr.png}
  \caption{Odpowiedzi układu z różnymi $Q$ i $R$}
\end{figure}

Z wykresu bezpośrednio można wyciągnąć wnioski o wpływie macierzy $Q$ i $R$ na sterowanie. Przebieg pomarańczowy, gdzie macierz $Q$ jest większa, priorytetyzuje osiągnięcie zadanej wartości jak najszybciej, robi to dostarczając do układu energię poprzez tłumienie oscylacji.
Przebieg zielony, priorytetyzujący za to minimalizację kosztu energetycznego, "pozwala" na większe oscylacje.

\subsection{Macierz P(t)}

\begin{figure}[H]
  \centering 
  \includegraphics[width=0.5\linewidth]{img/P(T).png}
  \caption{Elementy macierzy $P(t)$ dla $Q=I_2$, $R=1$ i $S=10I_2$}
\end{figure}


\subsection{Nieskończony kontra skończony horyzont czasowy}

Największe różnice pomiędzy działaniem regulatora LQR z nieskończonym i skończonym horyzontem czasowym można zaobserwować w przypadku, gdy czas regulacji jest krótszy niż potrzebny na osiągnięcie wartości zadanej, np.:

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/ithfthpor.png}
  \caption{Porównanie ITH i FTH}
\end{figure}

Na tym przebiegu wyraźnie widać różnice pomiędzy ITH i FTH. Widać, że druga zmienna stanu w skończonym horyzoncie około 0.7s zaczyna być forsowana do osiągnięcia celu. Widać też, że po zakończeniu regulacji będzie miała ona swojego rodzaju bezwładność. 

\subsection{Stabilizacja w punkcie}

\newpage
\begin{lstlisting}
  def model_FTH_setpoint(x_roz, t, x_d, u_d):
    x = x_roz[:2]
    x_vec = x.reshape(2, 1)
    x_d_vec = x_d.reshape(2, 1)
    
    P_t = get_P_t(t)
    K_t = R_inv @ B.T @ P_t
    
    #u = -K(x - x_d) + u_d
    u = -K_t @ (x_vec - x_d_vec) + u_d
    
    u_mat = u 
    
    dx = A @ x_vec + B @ u_mat
    
    return dx.flatten()

\end{lstlisting}



\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\linewidth]{img/stabilizacjawpunkcie.png}
  \caption{Stabilizacja w różnych punktach}
\end{figure}

Przy niewielkiej poprawce prawa sterowania da się łatwo doprowadzić regulator LQR do stabilizacji wokół danego punktu zamiast stabilizacji w zerze.






\end{document}